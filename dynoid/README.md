> [!IMPORTANT]
> DynoID is currently a [Heroku Labs][labs] feature and is not enabled by default for all spaces.

# DynoID

DynoID is a feature of [Heroku Private Spaces][spaces] that leverages [OpenID Connect][oidc] to mint tokens for each dyno on boot that it can use to authenticate and verify their identity to other services.

## Audiences

All dynos are get an `heroku` audience token by default. Additional audiences can be minted by setting the `HEROKU_DYNO_ID_AUDIENCES` config var to a comma separated list of audiences.


[spaces]: https://devcenter.heroku.com/articles/private-spaces
[oidc]: https://openid.net/developers/how-connect-works/
[labs]: https://devcenter.heroku.com/categories/labs

<!-- gomarkdoc:embed:start -->

<!-- Code generated by gomarkdoc. DO NOT EDIT -->

# dynoid

```go
import "github.com/heroku/x/dynoid"
```

## Index

- [Variables](<#variables>)
- [func LocalTokenPath\(audience string\) string](<#LocalTokenPath>)
- [func ReadLocal\(audience string\) \(string, error\)](<#ReadLocal>)
- [type IssuerCallback](<#IssuerCallback>)
  - [func AllowHerokuHost\(host string\) IssuerCallback](<#AllowHerokuHost>)
  - [func AllowHerokuSpace\(host string, spaceIDs ...string\) IssuerCallback](<#AllowHerokuSpace>)
- [type MalformedTokenError](<#MalformedTokenError>)
  - [func \(e \*MalformedTokenError\) Error\(\) string](<#MalformedTokenError.Error>)
  - [func \(e \*MalformedTokenError\) Unwrap\(\) error](<#MalformedTokenError.Unwrap>)
- [type Subject](<#Subject>)
  - [func \(s \*Subject\) LogValue\(\) slog.Value](<#Subject.LogValue>)
  - [func \(s \*Subject\) MarshalText\(\) \(\[\]byte, error\)](<#Subject.MarshalText>)
  - [func \(s \*Subject\) String\(\) string](<#Subject.String>)
  - [func \(s \*Subject\) UnmarshalText\(text \[\]byte\) error](<#Subject.UnmarshalText>)
- [type Token](<#Token>)
  - [func ReadLocalToken\(ctx context.Context, audience string\) \(\*Token, error\)](<#ReadLocalToken>)
  - [func \(t \*Token\) LogValue\(\) slog.Value](<#Token.LogValue>)
- [type UntrustedIssuerError](<#UntrustedIssuerError>)
  - [func \(e \*UntrustedIssuerError\) Error\(\) string](<#UntrustedIssuerError.Error>)
- [type Verifier](<#Verifier>)
  - [func New\(clientID string\) \*Verifier](<#New>)
  - [func NewWithCallback\(clientID string, callback IssuerCallback\) \*Verifier](<#NewWithCallback>)
  - [func \(v \*Verifier\) Verify\(ctx context.Context, rawIDToken string\) \(\*Token, error\)](<#Verifier.Verify>)


## Variables

<a name="DefaultFS"></a>DefaultFS is used by [ReadLocal](<#ReadLocal>) and [ReadLocalToken](<#ReadLocalToken>) to retrieve tokens.

By default they are retrieved via [os.Open](<https://pkg.go.dev/os/#Open>) and [os.ReadFile](<https://pkg.go.dev/os/#ReadFile>).

This is useful when testing code that uses DynoID.

```go
var DefaultFS fs.ReadFileFS = &osReader{}
```

<a name="LocalTokenPath"></a>
## func [LocalTokenPath](<https://github.com/heroku/x/blob/master/dynoid/dynoid.go#L146>)

```go
func LocalTokenPath(audience string) string
```

LocalTokenPath returns the path on disk to the token for the given audience

<a name="ReadLocal"></a>
## func [ReadLocal](<https://github.com/heroku/x/blob/master/dynoid/dynoid.go#L174>)

```go
func ReadLocal(audience string) (string, error)
```

ReadLocal reads the local machines token for the given audience

Suitable for passing as a bearer token

<a name="IssuerCallback"></a>
## type [IssuerCallback](<https://github.com/heroku/x/blob/master/dynoid/dynoid.go#L59>)

An IssuerCallback is called whenever a token is verified to ensure it matches some expected criteria.

```go
type IssuerCallback func(issuer string) error
```

<a name="AllowHerokuHost"></a>
### func [AllowHerokuHost](<https://github.com/heroku/x/blob/master/dynoid/dynoid.go#L63>)

```go
func AllowHerokuHost(host string) IssuerCallback
```

AllowHerokuHost verifies that the issuer is from Heroku for the given host domain

<a name="AllowHerokuSpace"></a>
### func [AllowHerokuSpace](<https://github.com/heroku/x/blob/master/dynoid/dynoid.go#L198>)

```go
func AllowHerokuSpace(host string, spaceIDs ...string) IssuerCallback
```

AllowHerokuSpace verifies that the issuer is from Heroku for the given host and space id.

<a name="MalformedTokenError"></a>
## type [MalformedTokenError](<https://github.com/heroku/x/blob/master/dynoid/dynoid.go#L35-L37>)

Returned when the token doesn't match the expected format

```go
type MalformedTokenError struct {
    // contains filtered or unexported fields
}
```

<a name="MalformedTokenError.Error"></a>
### func \(\*MalformedTokenError\) [Error](<https://github.com/heroku/x/blob/master/dynoid/dynoid.go#L39>)

```go
func (e *MalformedTokenError) Error() string
```



<a name="MalformedTokenError.Unwrap"></a>
### func \(\*MalformedTokenError\) [Unwrap](<https://github.com/heroku/x/blob/master/dynoid/dynoid.go#L43>)

```go
func (e *MalformedTokenError) Unwrap() error
```



<a name="Subject"></a>
## type [Subject](<https://github.com/heroku/x/blob/master/dynoid/dynoid.go#L74-L78>)

Subject contains information about the app and dyno the token was issued for

```go
type Subject struct {
    AppID   string `json:"app_id"`
    AppName string `json:"app_name"`
    Dyno    string `json:"dyno"`
}
```

<a name="Subject.LogValue"></a>
### func \(\*Subject\) [LogValue](<https://github.com/heroku/x/blob/master/dynoid/dynoid.go#L80>)

```go
func (s *Subject) LogValue() slog.Value
```



<a name="Subject.MarshalText"></a>
### func \(\*Subject\) [MarshalText](<https://github.com/heroku/x/blob/master/dynoid/dynoid.go#L92>)

```go
func (s *Subject) MarshalText() ([]byte, error)
```



<a name="Subject.String"></a>
### func \(\*Subject\) [String](<https://github.com/heroku/x/blob/master/dynoid/dynoid.go#L119>)

```go
func (s *Subject) String() string
```



<a name="Subject.UnmarshalText"></a>
### func \(\*Subject\) [UnmarshalText](<https://github.com/heroku/x/blob/master/dynoid/dynoid.go#L96>)

```go
func (s *Subject) UnmarshalText(text []byte) error
```



<a name="Token"></a>
## type [Token](<https://github.com/heroku/x/blob/master/dynoid/dynoid.go#L128-L132>)

Token contains all of the token information stored by Heroku when it's issued

```go
type Token struct {
    IDToken *oidc.IDToken `json:"-"`
    SpaceID string        `json:"space_id"`
    Subject *Subject      `json:"subject"`
}
```

<a name="ReadLocalToken"></a>
### func [ReadLocalToken](<https://github.com/heroku/x/blob/master/dynoid/dynoid.go#L185>)

```go
func ReadLocalToken(ctx context.Context, audience string) (*Token, error)
```

ReadLocalToken reads the local machines token for the given audience and parses it

<a name="Token.LogValue"></a>
### func \(\*Token\) [LogValue](<https://github.com/heroku/x/blob/master/dynoid/dynoid.go#L134>)

```go
func (t *Token) LogValue() slog.Value
```



<a name="UntrustedIssuerError"></a>
## type [UntrustedIssuerError](<https://github.com/heroku/x/blob/master/dynoid/dynoid.go#L26-L28>)

Returned by an IssuerCallback getting an issuer it doesn't trust

```go
type UntrustedIssuerError struct {
    Issuer string
}
```

<a name="UntrustedIssuerError.Error"></a>
### func \(\*UntrustedIssuerError\) [Error](<https://github.com/heroku/x/blob/master/dynoid/dynoid.go#L30>)

```go
func (e *UntrustedIssuerError) Error() string
```



<a name="Verifier"></a>
## type [Verifier](<https://github.com/heroku/x/blob/master/dynoid/dynoid.go#L212-L219>)

A Verifier verifies a raw token with it's oids issuer and uses the IssuerCallback to ensure it's from a trusted source.

```go
type Verifier struct {
    IssuerCallback IssuerCallback
    // contains filtered or unexported fields
}
```

<a name="New"></a>
### func [New](<https://github.com/heroku/x/blob/master/dynoid/dynoid.go#L225>)

```go
func New(clientID string) *Verifier
```

Instantiate a new Verifier without an IssuerCallback set.

The IssuerCallback must be set before calling Verify or an error will be returned.

<a name="NewWithCallback"></a>
### func [NewWithCallback](<https://github.com/heroku/x/blob/master/dynoid/dynoid.go#L234>)

```go
func NewWithCallback(clientID string, callback IssuerCallback) *Verifier
```

Instantiate a new Verifier with the IssuerCallback set.

<a name="Verifier.Verify"></a>
### func \(\*Verifier\) [Verify](<https://github.com/heroku/x/blob/master/dynoid/dynoid.go#L242>)

```go
func (v *Verifier) Verify(ctx context.Context, rawIDToken string) (*Token, error)
```

Verify validates the given token with the OIDC provider and validates it against the IssuerCallback

# dynoidtest

```go
import "github.com/heroku/x/dynoid/dynoidtest"
```

dynoidtest provides helper functions for testing code that uses DynoID

## Index

- [Constants](<#constants>)
- [func GenerateDefaultFS\(iss \*Issuer, audiences ...string\) error](<#GenerateDefaultFS>)
- [func Issue\(iss \*Issuer\) http.Handler](<#Issue>)
- [func LocalIssuer\(iss \*Issuer\) func\(http.Handler\) http.Handler](<#LocalIssuer>)
- [type FS](<#FS>)
  - [func NewFS\(tokens map\[string\]string\) \*FS](<#NewFS>)
  - [func \(f \*FS\) Open\(name string\) \(fs.File, error\)](<#FS.Open>)
  - [func \(f \*FS\) ReadFile\(name string\) \(\[\]byte, error\)](<#FS.ReadFile>)
- [type Issuer](<#Issuer>)
  - [func New\(opts ...IssuerOpt\) \(\*Issuer, error\)](<#New>)
  - [func NewWithContext\(ctx context.Context, opts ...IssuerOpt\) \(context.Context, \*Issuer, error\)](<#NewWithContext>)
  - [func \(iss \*Issuer\) GenerateIDToken\(clientID string, opts ...TokenOpt\) \(string, error\)](<#Issuer.GenerateIDToken>)
  - [func \(iss \*Issuer\) HTTPClient\(\) \*http.Client](<#Issuer.HTTPClient>)
- [type IssuerOpt](<#IssuerOpt>)
  - [func WithIssuerHost\(host string\) IssuerOpt](<#WithIssuerHost>)
  - [func WithKey\(key \*rsa.PrivateKey\) IssuerOpt](<#WithKey>)
  - [func WithSpaceID\(spaceID string\) IssuerOpt](<#WithSpaceID>)
  - [func WithTokenOpts\(opts ...TokenOpt\) IssuerOpt](<#WithTokenOpts>)
- [type LocalConfiguration](<#LocalConfiguration>)
  - [func ConfigureLocal\(audiences \[\]string, opts ...IssuerOpt\) \(\*LocalConfiguration, error\)](<#ConfigureLocal>)
  - [func \(c \*LocalConfiguration\) GenerateToken\(audience string\) \(string, error\)](<#LocalConfiguration.GenerateToken>)
  - [func \(c \*LocalConfiguration\) Handler\(\) http.Handler](<#LocalConfiguration.Handler>)
  - [func \(c \*LocalConfiguration\) Middleware\(\) func\(http.Handler\) http.Handler](<#LocalConfiguration.Middleware>)
- [type TokenOpt](<#TokenOpt>)
  - [func WithSubject\(s \*dynoid.Subject\) TokenOpt](<#WithSubject>)
  - [func WithSubjectFunc\(fn func\(audience string, subject \*dynoid.Subject\) \*dynoid.Subject\) TokenOpt](<#WithSubjectFunc>)


## Constants

<a name="DefaultIssuerHost"></a>

```go
const (
    DefaultIssuerHost = "heroku.local"                         // issuer host used when one is not provided
    DefaultSpaceID    = "test"                                 // space id used when one is not provided
    DefaultAppID      = "00000000-0000-0000-0000-000000000001" // app id used when one is not provided
    DefaultAppName    = "sushi"                                // app name used when one is not provided
    DefaultDyno       = "web.1"                                // dyno used when one is not provided
)
```

<a name="GenerateDefaultFS"></a>
## func [GenerateDefaultFS](<https://github.com/heroku/x/blob/master/dynoid/dynoidtest/local.go#L56>)

```go
func GenerateDefaultFS(iss *Issuer, audiences ...string) error
```

Configure dynoid.DefaultFS to use tokens generated by the provided issuer for the audiences listed.

<a name="Issue"></a>
## func [Issue](<https://github.com/heroku/x/blob/master/dynoid/dynoidtest/local.go#L86>)

```go
func Issue(iss *Issuer) http.Handler
```

The Issue http.Handler generates test tokens via a local Issuer using the provided opts.

A query param 'audience' is expected.

<a name="LocalIssuer"></a>
## func [LocalIssuer](<https://github.com/heroku/x/blob/master/dynoid/dynoidtest/local.go#L73>)

```go
func LocalIssuer(iss *Issuer) func(http.Handler) http.Handler
```

Configures the oidc client to use the issuer provided.

<a name="FS"></a>
## type [FS](<https://github.com/heroku/x/blob/master/dynoid/dynoidtest/file.go#L14-L16>)

FS implements fs.ReadFileFS and is suitable for testing reading tokens.

```go
type FS struct {
    // contains filtered or unexported fields
}
```

<a name="NewFS"></a>
### func [NewFS](<https://github.com/heroku/x/blob/master/dynoid/dynoidtest/file.go#L23>)

```go
func NewFS(tokens map[string]string) *FS
```

Create a new FS where the DynoID tokens have been populated.

The tokens map keys are the expected audience and the values are the token contents.

<a name="FS.Open"></a>
### func \(\*FS\) [Open](<https://github.com/heroku/x/blob/master/dynoid/dynoidtest/file.go#L34>)

```go
func (f *FS) Open(name string) (fs.File, error)
```



<a name="FS.ReadFile"></a>
### func \(\*FS\) [ReadFile](<https://github.com/heroku/x/blob/master/dynoid/dynoidtest/file.go#L43>)

```go
func (f *FS) ReadFile(name string) ([]byte, error)
```



<a name="Issuer"></a>
## type [Issuer](<https://github.com/heroku/x/blob/master/dynoid/dynoidtest/dynoidtest.go#L32-L37>)

Issuer generates test tokens and provides a client for verifying them.

```go
type Issuer struct {
    // contains filtered or unexported fields
}
```

<a name="New"></a>
### func [New](<https://github.com/heroku/x/blob/master/dynoid/dynoidtest/dynoidtest.go#L86>)

```go
func New(opts ...IssuerOpt) (*Issuer, error)
```

Create a new Issuer with the supplied opts applied

<a name="NewWithContext"></a>
### func [NewWithContext](<https://github.com/heroku/x/blob/master/dynoid/dynoidtest/dynoidtest.go#L92>)

```go
func NewWithContext(ctx context.Context, opts ...IssuerOpt) (context.Context, *Issuer, error)
```

Create a new Issuer with the supplied opts applied inheriting from the provided context

<a name="Issuer.GenerateIDToken"></a>
### func \(\*Issuer\) [GenerateIDToken](<https://github.com/heroku/x/blob/master/dynoid/dynoidtest/dynoidtest.go#L145>)

```go
func (iss *Issuer) GenerateIDToken(clientID string, opts ...TokenOpt) (string, error)
```

GenerateIDToken returns a new signed token as a string

<a name="Issuer.HTTPClient"></a>
### func \(\*Issuer\) [HTTPClient](<https://github.com/heroku/x/blob/master/dynoid/dynoidtest/dynoidtest.go#L169>)

```go
func (iss *Issuer) HTTPClient() *http.Client
```

HTTPClient returns a client that leverages the Issuer to validate tokens.

<a name="IssuerOpt"></a>
## type [IssuerOpt](<https://github.com/heroku/x/blob/master/dynoid/dynoidtest/dynoidtest.go#L40-L42>)

IssuerOpt allows the behavior of the issuer to be modified.

```go
type IssuerOpt interface {
    // contains filtered or unexported methods
}
```

<a name="WithIssuerHost"></a>
### func [WithIssuerHost](<https://github.com/heroku/x/blob/master/dynoid/dynoidtest/dynoidtest.go#L61>)

```go
func WithIssuerHost(host string) IssuerOpt
```

WithIssuerHost allows an issuer host to be supplied instead of using the default

<a name="WithKey"></a>
### func [WithKey](<https://github.com/heroku/x/blob/master/dynoid/dynoidtest/dynoidtest.go#L52>)

```go
func WithKey(key *rsa.PrivateKey) IssuerOpt
```

WithKey allows you to set the issuer's private key. Useful for leveraging test middleware.

<a name="WithSpaceID"></a>
### func [WithSpaceID](<https://github.com/heroku/x/blob/master/dynoid/dynoidtest/dynoidtest.go#L69>)

```go
func WithSpaceID(spaceID string) IssuerOpt
```

WithSpaceID allows a spaceID to be supplied instead of using the default

<a name="WithTokenOpts"></a>
### func [WithTokenOpts](<https://github.com/heroku/x/blob/master/dynoid/dynoidtest/dynoidtest.go#L78>)

```go
func WithTokenOpts(opts ...TokenOpt) IssuerOpt
```

WithTokenOpts allows a default set of TokenOpt to be applied to every token generated by the issuer

<a name="LocalConfiguration"></a>
## type [LocalConfiguration](<https://github.com/heroku/x/blob/master/dynoid/dynoidtest/local.go#L15-L17>)

LocalConfiguration provides methods for working with a local issuer configured with ConfigureLocal

```go
type LocalConfiguration struct {
    // contains filtered or unexported fields
}
```

<a name="ConfigureLocal"></a>
### func [ConfigureLocal](<https://github.com/heroku/x/blob/master/dynoid/dynoidtest/local.go#L41>)

```go
func ConfigureLocal(audiences []string, opts ...IssuerOpt) (*LocalConfiguration, error)
```

ConfigureLocal sets up the environment with a local DynoID issuer and generates tokens for the audiences provided.

The returned LocalConfiguration provides methods for working with the issuer.

<a name="LocalConfiguration.GenerateToken"></a>
### func \(\*LocalConfiguration\) [GenerateToken](<https://github.com/heroku/x/blob/master/dynoid/dynoidtest/local.go#L33>)

```go
func (c *LocalConfiguration) GenerateToken(audience string) (string, error)
```

GenerateToken mints a token for the given audience using the configured issuer.

<a name="LocalConfiguration.Handler"></a>
### func \(\*LocalConfiguration\) [Handler](<https://github.com/heroku/x/blob/master/dynoid/dynoidtest/local.go#L27>)

```go
func (c *LocalConfiguration) Handler() http.Handler
```

Handler mints tokens for the configured issuer using for the audience specified by the audience query param.

<a name="LocalConfiguration.Middleware"></a>
### func \(\*LocalConfiguration\) [Middleware](<https://github.com/heroku/x/blob/master/dynoid/dynoidtest/local.go#L21>)

```go
func (c *LocalConfiguration) Middleware() func(http.Handler) http.Handler
```

The Middleware should be inserted in the middleware stack before any functions that use dynoid are called.

<a name="TokenOpt"></a>
## type [TokenOpt](<https://github.com/heroku/x/blob/master/dynoid/dynoidtest/dynoidtest.go#L111-L113>)

A TokenOpt modifies the way a token is minted

```go
type TokenOpt interface {
    // contains filtered or unexported methods
}
```

<a name="WithSubject"></a>
### func [WithSubject](<https://github.com/heroku/x/blob/master/dynoid/dynoidtest/dynoidtest.go#L122>)

```go
func WithSubject(s *dynoid.Subject) TokenOpt
```

WithSubject allows the Subject to be different than the default

<a name="WithSubjectFunc"></a>
### func [WithSubjectFunc](<https://github.com/heroku/x/blob/master/dynoid/dynoidtest/dynoidtest.go#L131>)

```go
func WithSubjectFunc(fn func(audience string, subject *dynoid.Subject) *dynoid.Subject) TokenOpt
```

WithSubjectFunc allows the Subject to be different than the default based on the audience being generated.

# middleware

```go
import "github.com/heroku/x/dynoid/middleware"
```

## Index

- [Variables](<#variables>)
- [func AddToContext\(ctx context.Context, token \*dynoid.Token, err error\) context.Context](<#AddToContext>)
- [func Authorize\(audience string, callback dynoid.IssuerCallback\) func\(http.Handler\) http.Handler](<#Authorize>)
- [func AuthorizeSameSpace\(audience string\) func\(http.Handler\) http.Handler](<#AuthorizeSameSpace>)
- [func AuthorizeSpaces\(audience string, spaces ...string\) func\(http.Handler\) http.Handler](<#AuthorizeSpaces>)
- [func AuthorizeSpacesWithIssuer\(audience, issuer string, spaces ...string\) func\(http.Handler\) http.Handler](<#AuthorizeSpacesWithIssuer>)
- [func FromContext\(ctx context.Context\) \(\*dynoid.Token, error\)](<#FromContext>)
- [func Populate\(audience string, callback dynoid.IssuerCallback\) func\(http.Handler\) http.Handler](<#Populate>)


## Variables

<a name="ErrTokenMissing"></a>

```go
var (
    ErrTokenMissing = errors.New("token not found")
)
```

<a name="AddToContext"></a>
## func [AddToContext](<https://github.com/heroku/x/blob/master/dynoid/middleware/dynoid.go#L88>)

```go
func AddToContext(ctx context.Context, token *dynoid.Token, err error) context.Context
```

AddToContext adds the Token to the given context

<a name="Authorize"></a>
## func [Authorize](<https://github.com/heroku/x/blob/master/dynoid/middleware/dynoid.go#L38>)

```go
func Authorize(audience string, callback dynoid.IssuerCallback) func(http.Handler) http.Handler
```

Authorize populates the dyno identity blocks requests where the callback fails.

<a name="AuthorizeSameSpace"></a>
## func [AuthorizeSameSpace](<https://github.com/heroku/x/blob/master/dynoid/middleware/dynoid.go#L56>)

```go
func AuthorizeSameSpace(audience string) func(http.Handler) http.Handler
```

AuthorizeSameSpace restricts access to tokens from the same space/issuer for the given audience.

<a name="AuthorizeSpaces"></a>
## func [AuthorizeSpaces](<https://github.com/heroku/x/blob/master/dynoid/middleware/dynoid.go#L70>)

```go
func AuthorizeSpaces(audience string, spaces ...string) func(http.Handler) http.Handler
```

AuthorizeSpaces populates the dyno identity and blocks any requests that aren't from one of the given spaces.

<a name="AuthorizeSpacesWithIssuer"></a>
## func [AuthorizeSpacesWithIssuer](<https://github.com/heroku/x/blob/master/dynoid/middleware/dynoid.go#L83>)

```go
func AuthorizeSpacesWithIssuer(audience, issuer string, spaces ...string) func(http.Handler) http.Handler
```

AuthorizeSpacesWithIssuer populates the dyno identity and blocks any requests that aren't from one of the given spaces and issuer.

<a name="FromContext"></a>
## func [FromContext](<https://github.com/heroku/x/blob/master/dynoid/middleware/dynoid.go#L95>)

```go
func FromContext(ctx context.Context) (*dynoid.Token, error)
```

FromContext fetches the Token from the context

<a name="Populate"></a>
## func [Populate](<https://github.com/heroku/x/blob/master/dynoid/middleware/dynoid.go#L27>)

```go
func Populate(audience string, callback dynoid.IssuerCallback) func(http.Handler) http.Handler
```

Populate attempts to validate and parse a Token from the request for the given audience but doesn't enforce any restrictions.

Generated by [gomarkdoc](<https://github.com/princjef/gomarkdoc>)


<!-- gomarkdoc:embed:end -->

